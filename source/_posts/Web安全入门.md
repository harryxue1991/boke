---
title: Web安全入门
date: 2017-04-09 19:41:03
tags:
---

我们知道，http请求在网络中明文传输的，毫无隐私可言。以前经常遇到打开某个知名门户网站，右下角居然跳出联通的小广告。因为http的不保密性，运营商可以肆意地窥看信息，篡改响应内容，比如给自己打个广告什么的。当然，随着时代的进步，必然会出现遏制恶势力的救世主，怎么个救法呢？且听我娓娓道来。

<!-- more -->

怎么保证我的内容不被运营商修改？加密呗，加了密他肯定看不懂了吧。不过问题来了，我这加了密，运营商看不懂，客户也看不懂啊。一定的想办法把解密的方法告诉客户才行。可是我要把解密方法发给客户还得经过运营商，那不是白扯。

问题很严重，难道没办法了？显然不可能，不然我也不会在这里逼逼叨了。

这时候我们有请第一位英雄出场：**非对称加密**

你可能会问，什么是非对称加密？别急，他还有一位兄弟你肯定认识：**对称加密**。什么，也不认识？好吧。简单解释一下你肯定明白了：一把锁配一把钥匙，上锁开锁都必须使用这同一把钥匙，你要是用锁把门锁了，用这把钥匙就可以开门。这不是废话么。这其实就是对称加密，一个锁和唯一的一把钥匙对称。缺点显而易见，隔壁老王偷偷拿了你的钥匙多磨了一把，以后岂不是随意进你家门了。说完他兄弟，我们还是回到非对称加密，什么是非对称加密呢？举个栗子：

你去河边捡了个鹅卵石，一怒之下将其摔成了两半。好了，在这世界上你找不出第三块石头能和它俩任意一个完美契合的了。如果有人用左半边石头加密了一串文本，有且只有另一半石头能解开这个密码。你只要保管好右半边的石头，任何人用左半边加密的内容都可以被你解开，再也不用担心左半边石头丢失的问题了。这就是著名的RSA非对称加密算法，基于大数的因式分解数学难题，也是应用最广泛的非对称加密算法。

人们把左、右半边石头分别称为**公钥**和**私钥**，那么解决运营商劫持问题可以这样：

1. 客户A发起请求
2. 服务器B收到请求，生成自己的公钥和密钥，将公钥返回给客户A
3. 客户A收到返回的公钥，使用这个公钥对自己要发送的内容加密，发送给服务器B
4. 服务器B收到加密后的内容，使用之前生成的私钥解密，得到内容
5. 服务器B使用自己的私钥加密响应体，返回给客户A
6. 客户A收到服务器B的响应，使用之前的公钥对其解密，得到内容

是不是很完美？

当然不是。看似网络中传输的内容都已经加密了啊，并且私钥也没有暴露出去，有啥问题呢？

一个很大的隐患就是，假设这个运营商特别狡猾，当服务器B返回公钥给客户A的时候，偷偷将这个公钥劫持，自己再造一份公钥和密钥，将这个假的公钥发给客户，与客户建立连接。这就是经典的中间人攻击。

那怎么解决呢，有请我们的第二位英雄出场：**数字证书**

数字证书是由权威的CA机构颁发给服务商的一种身份证明，就是标识某某是个好人，有了这个标识，我们的改良方案就成了这样：

1. 客户A发起请求
2. 服务器B收到请求，将自己的数字证书返回给客户A
3. 客户A收到B发来的数字证书，读取证书中的发布机构（Issuer），然后从操作系统的受信任机构列表中查找该证书颁发机构的公钥。如果找不到，说明这个机构是不被信任的。
4. A使用上一步取到的CA的公钥，解码数字证书，得到的B的身份信息（当然也可能是中间人冒充的）和数字签名。
5. A通过证书指定的加密算法对可能是B的身份信息进行hash取得信息摘要
6. 加密后的结果和证书中解出的数字签名进行对比，如果相同，就说明这份身份信息确实是B的，也就是说身份信息中包含的公钥确实是B的，也就验证了B的身份。

这样一来，运营商就没法冒充我们啦~完美！

更为详细的步骤请看下图：

![ss](http://odl96infd.bkt.clouddn.com/2017-04-09-ssl.jpg)

## 一些基本概念

> 对称加密和非对称加密

这世上存在两种加密算法：对称加密(symmetric cryptography)和非对称加密(asymmetric cryptography)。

- 对称加密：对称加密算法的特点是加密使用的密钥和解密使用的密钥是相同的。好比一把锁，上锁和开锁使用的是同一把钥匙。
- 非对称加密：在非对称加密算法中，有公钥和私钥两种密钥，其中，公钥是公开的，不需要保密，私钥由个人持有，必须妥善保管和注意保密。加密和解密使用两种不同的密钥，是它得名的原因。估计大家都听说过RSA，这就是一种常见的，应用很广的非对称加密算法。

**常见的加密算法**：

对称加密 | 非对称加密 | 信息摘要
---- | ---- | ----
AES(128) DES(64) Blowfish(64) CAST(64) IDEA(64) RC2(64) RC5(64) | DH RSA DSA EC | MD2 MD5 MDC2 SHA RIPEMD DSS

> SSL/TLS

什么是SSL？全称是：Secure Sockets Layer，一种**协议**，定义了用来对网络发出数据的进行加密解密的格式和规则。TLS（Transport Layer Security）和SSL类似，可以将其与SSL视为同一东西的不同阶段。

> HTTPS

http是一种应用层通信协议，SSL/TLS是一种用在传输层的加密协议，于是两者一拍即合，出于安全通信的目的，http配合SSL/TLS就成为了HTTPS。

>OpenSSL

什么是OpenSSL？它是在程序上对SSL标准的一个实现，提供了：

- libcrypto通用加密库
- libssl TLS/SSL的实现
- openssl命令行工具

> SSH

一个使用了OpenSSL加密的通信工具，提供了很多安全功能。

> CA

(certificate authority)证书管理机构

> 数字证书

可以这么理解，数字证书是一个网站的身份证，当网站的响应返回时会携带这个身份证，告诉客户端其身份，它包含如下信息：

- 证书的发布机构
- 证书的有效期
- 用户公钥
- 用户名称
- 数字签名